<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1월의 기록: 설렘과 다짐</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas (이미지 저장용) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f0e9; /* 부드러운 종이 질감 색상 */
            color: #2c2c2c;
        }
        
        .book-font {
            font-family: 'Nanum Myeongjo', serif;
        }

        /* 스크롤바 숨기기 및 커스텀 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; }
        textarea::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }

        /* 토스트 팝업 애니메이션 */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        .toast-show {
            animation: fadeInOut 3s forwards;
        }

        /* 팝업 오버레이 */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        /* 설정 모달 */
        #settings-overlay .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* 이미지 갤러리 스타일 */
        .image-gallery {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 4px;
            margin-bottom: 12px;
            scroll-behavior: smooth;
        }
        .image-gallery::-webkit-scrollbar { height: 6px; }
        .image-gallery::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        .image-item {
            position: relative;
            flex-shrink: 0;
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* 삭제 버튼 스타일 개선 (클릭 영역 확보 및 z-index 상향) */
        .remove-image-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50; /* 최상위로 배치 */
            border: none;
        }
        .remove-image-btn:hover { 
            background: rgba(220, 38, 38, 0.9); 
            transform: scale(1.1);
        }

        /* 카드 생성용 템플릿 (화면 밖 숨김) */
        #share-card-template {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 600px;
            background-color: #fff;
            padding: 40px;
            box-sizing: border-box;
            border: 1px solid #eee;
            font-family: 'Nanum Myeongjo', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            /* 종이 질감 배경 */
            background-image: linear-gradient(0deg, transparent 24%, #f8f8f8 25%, #f8f8f8 26%, transparent 27%, transparent 74%, #f8f8f8 75%, #f8f8f8 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            background-color: #fffefb;
        }

        /* 수동 복사 영역 (서식 유지) */
        #manual-copy-area {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 14px;
            overflow-y: auto;
            text-align: left;
            background-color: #fff;
            white-space: normal;
            word-break: break-word;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        #manual-copy-area img {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 selection:bg-stone-200">

    <!-- ... (Settings Overlay Code Remains Same) ... -->
    <!-- 데이터 관리 (설정) 오버레이 -->
    <div id="settings-overlay" class="overlay">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold book-font text-stone-800 mb-6">데이터 관리 (1월)</h2>
            
            <div class="space-y-3">
                <button onclick="backupData()" class="w-full bg-stone-100 hover:bg-stone-200 text-stone-700 py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition">
                    <i data-lucide="download-cloud" class="w-5 h-5"></i>
                    <div class="text-left">
                        <div class="font-bold text-sm">파일로 백업하기</div>
                        <div class="text-xs text-stone-500">1월의 기록을 파일로 저장합니다</div>
                    </div>
                </button>

                <button onclick="document.getElementById('restore-input').click()" class="w-full bg-stone-100 hover:bg-stone-200 text-stone-700 py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                    <div class="text-left">
                        <div class="font-bold text-sm">데이터 복구하기</div>
                        <div class="text-xs text-stone-500">백업 파일을 불러와 기록을 복원합니다</div>
                    </div>
                </button>
                <input type="file" id="restore-input" class="hidden" accept=".json" onchange="restoreData(event)">
                
                <hr class="border-stone-200 my-4">
                
                <button onclick="resetData()" class="w-full text-red-400 hover:text-red-600 py-2 text-sm flex items-center justify-center gap-2 transition">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> 초기화 (1월 데이터 삭제)
                </button>
            </div>

            <button onclick="closeOverlay('settings-overlay')" class="mt-6 w-full bg-stone-800 text-white py-2 rounded-lg hover:bg-stone-900 transition">
                닫기
            </button>
        </div>
    </div>

    <!-- ... (Export Overlay Code Remains Same) ... -->
    <!-- 내보내기 가이드 오버레이 -->
    <div id="export-overlay" class="overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg text-center mx-4 w-full">
            <div id="export-status-container">
                <div class="mb-4 text-stone-600 flex justify-center">
                    <div id="status-icon"></div>
                </div>
                <h2 id="status-title" class="text-2xl font-bold book-font text-stone-800 mb-2">복사 준비 완료</h2>
                <p id="status-message" class="text-stone-600 mb-4 text-sm leading-relaxed">
                    아래 영역이 파랗게 선택되었나요?<br>
                    그렇다면 <strong>Ctrl + C</strong> 를 눌러 복사하세요.<br>
                    (자동 복사가 되었다면 바로 붙여넣기 하셔도 됩니다)
                </p>
                
                <div id="manual-copy-area" contenteditable="true" onclick="selectAllManual()"></div>
                
                <div class="flex gap-2 justify-center mt-4">
                    <button onclick="openGoogleDocs()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                        <i data-lucide="external-link" class="w-5 h-5"></i> 구글 문서 열기
                    </button>
                    <button onclick="copyToClipboardManual()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 font-bold py-3 px-4 rounded-lg transition">
                        다시 복사 시도
                    </button>
                </div>
            </div>

            <button onclick="closeOverlay('export-overlay')" class="mt-4 text-sm text-stone-400 hover:text-stone-600 underline">
                닫기
            </button>
        </div>
    </div>

    <!-- ... (Share Overlay Code Remains Same) ... -->
    <!-- 카드 공유 미리보기 오버레이 -->
    <div id="share-overlay" class="overlay">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center mx-4 relative">
            <button onclick="closeOverlay('share-overlay')" class="absolute top-4 right-4 text-stone-400 hover:text-stone-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <h2 class="text-xl font-bold book-font text-stone-800 mb-4">오늘의 기록 공유하기</h2>
            
            <div id="share-preview-area" class="w-full bg-stone-100 rounded-lg mb-6 overflow-hidden flex items-center justify-center min-h-[200px]">
                <img id="generated-share-image" class="max-w-full h-auto shadow-md" alt="공유 이미지">
            </div>

            <div class="flex flex-col gap-2">
                <button onclick="downloadShareImage()" class="w-full bg-stone-800 hover:bg-stone-900 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> 이미지 저장
                </button>
                <p class="text-xs text-stone-400 mt-1">저장된 이미지를 인스타그램이나 카톡으로 공유해보세요!</p>
            </div>
        </div>
    </div>

    <!-- 상단 헤더 및 네비게이션 -->
    <header class="w-full max-w-3xl flex flex-wrap gap-2 justify-between items-center mb-6 z-10">
        <div class="flex flex-col">
            <h1 class="text-xl md:text-2xl font-bold book-font text-stone-700">1월의 시작</h1>
            <p class="text-xs text-stone-500 mt-1">설렘과 다짐의 기록</p>
        </div>
        <div class="flex gap-2 items-center">
            <button onclick="shareCurrentCard()" class="flex items-center gap-2 bg-white border border-stone-300 hover:bg-stone-50 text-stone-700 px-3 py-2 rounded-lg shadow-sm transition text-sm font-medium" title="오늘의 질문 공유하기">
                <i data-lucide="share-2" class="w-4 h-4"></i> <span class="hidden sm:inline">공유</span>
            </button>
            <button id="btn-export" onclick="copyForGoogleDocs()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg shadow-sm transition text-sm font-medium" title="구글 문서로 내보내기">
                <i data-lucide="file-text" class="w-4 h-4"></i> <span class="hidden sm:inline">내보내기</span>
            </button>
            <button onclick="openSettings()" class="flex items-center justify-center bg-stone-200 hover:bg-stone-300 text-stone-700 w-9 h-9 rounded-lg transition" title="데이터 관리 (백업/복구)">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- 메인 앱 컨테이너 -->
    <main id="app" class="w-full max-w-3xl bg-white rounded-xl shadow-2xl overflow-hidden min-h-[600px] flex flex-col relative border border-stone-200 z-10">
        
        <!-- 표지 이미지 헤더 -->
        <div class="relative w-full h-48 bg-stone-200 overflow-hidden">
            <!-- Unsplash Image with explicit sizing -->
            <img src="https://images.unsplash.com/photo-1517842645767-c639042777db?ixlib=rb-4.0.3&auto=format&fit=crop&w=1080&q=80" alt="Cover" class="w-full h-full object-cover opacity-90">
            <div class="absolute inset-0 bg-slate-900/40 flex flex-col items-center justify-center text-white">
                <div class="text-sm font-light tracking-widest mb-2 opacity-90">REBOOT NOTE</div>
                <h2 class="text-3xl font-bold book-font drop-shadow-md">1월의 기록</h2>
                <div class="w-10 h-0.5 bg-white/70 my-3"></div>
                <p class="text-sm font-light opacity-90">설렘과 다짐</p>
            </div>
        </div>

        <!-- 로딩 상태 -->
        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white z-50">
            <div class="animate-pulse text-stone-400">페이지를 불러오는 중...</div>
        </div>

        <!-- 날짜 탭 (스크롤 가능) -->
        <div class="w-full bg-stone-50 border-b border-stone-200 py-3">
            <div id="tab-container" class="flex flex-col gap-2">
                <!-- JS로 탭 버튼 생성됨 -->
            </div>
        </div>

        <!-- 상단: 챕터 & 날짜 -->
        <div class="bg-stone-50 px-6 py-4 border-b border-stone-100 flex justify-between items-center">
            <div class="flex flex-col">
                <span id="chapter-display" class="text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Chapter 1</span>
                <div id="date-display" class="font-bold text-stone-700 text-lg"></div>
            </div>
            <div class="flex items-center gap-2">
                 <!-- 저장 완료 토스트 메시지 -->
                <div id="save-toast" class="hidden text-xs text-green-600 font-medium flex items-center gap-1 bg-green-50 px-2 py-1 rounded">
                    <i data-lucide="check" class="w-3 h-3"></i> 저장 완료!
                </div>
                <div class="text-xs text-stone-400 font-mono tracking-widest" id="page-indicator">1 / 31</div>
            </div>
        </div>

        <!-- 중간: 질문 및 글쓰기 영역 -->
        <div class="flex-1 p-6 md:p-10 flex flex-col justify-center">
            
            <!-- 질문 -->
            <div class="mb-8 text-center">
                <h2 id="question-text" class="text-2xl md:text-3xl font-bold book-font leading-relaxed text-stone-800 break-keep">
                    <!-- JS로 주입됨 -->
                </h2>
            </div>

            <!-- 글쓰기 영역 -->
            <div class="w-full flex-1 relative flex flex-col">
                
                <!-- 사진 미리보기 -->
                <div id="image-gallery-container" class="hidden">
                    <div id="image-list" class="image-gallery">
                        <!-- JS로 이미지 주입됨 -->
                    </div>
                </div>

                <div class="relative w-full">
                    <textarea 
                        id="answer-input" 
                        class="w-full h-64 p-6 bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-300 focus:bg-white resize-none text-stone-700 leading-8 book-font text-lg transition-colors pb-10"
                        placeholder="이곳에 당신의 마음을 기록해보세요..."
                        maxlength="1000"
                    ></textarea>
                    
                    <!-- 글자수 -->
                    <div class="absolute bottom-4 right-4 text-xs text-stone-400 pointer-events-none">
                        <span id="char-count">0</span>자
                    </div>
                </div>

                <!-- 툴바: 사진 첨부 & 저장 -->
                <div class="flex justify-between items-center mt-3 px-1">
                    <!-- 사진 업로드 버튼 -->
                    <div>
                        <input type="file" id="image-upload" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)">
                        <button onclick="document.getElementById('image-upload').click()" class="flex items-center gap-1.5 px-3 py-1.5 text-stone-500 hover:text-stone-700 hover:bg-stone-100 rounded transition-colors text-sm">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            <span>사진 추가</span>
                        </button>
                    </div>

                    <!-- 수동 저장 버튼 -->
                    <button onclick="manualSave()" class="flex items-center gap-1.5 px-3 py-1.5 bg-stone-200 hover:bg-stone-300 text-stone-600 text-sm rounded transition-colors duration-200">
                        <i data-lucide="save" class="w-4 h-4"></i> 지금 저장하기
                    </button>
                </div>
            </div>

            <!-- 명언 -->
            <div class="mt-6 pt-6 border-t border-stone-100 text-center">
                <p class="text-sm text-stone-500 italic book-font" id="quote-text">
                    <!-- JS로 주입됨 -->
                </p>
            </div>
        </div>

        <!-- 하단: 이전/다음 버튼 -->
        <div class="bg-stone-50 p-4 border-t border-stone-100 flex justify-between items-center">
            <button onclick="prevPage()" id="btn-prev" class="flex items-center gap-2 px-4 py-2 text-stone-500 hover:text-stone-800 disabled:opacity-30 disabled:hover:text-stone-500 transition">
                <i data-lucide="chevron-left" class="w-5 h-5"></i> 이전
            </button>
            
            <button onclick="nextPage()" id="btn-next" class="flex items-center gap-2 px-4 py-2 text-stone-500 hover:text-stone-800 disabled:opacity-30 disabled:hover:text-stone-500 transition">
                다음 <i data-lucide="chevron-right" class="w-5 h-5"></i>
            </button>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="mt-8 text-stone-400 text-xs text-center z-10">
        <p>작성된 내용은 브라우저에 자동 저장됩니다.</p>
    </footer>

    <!-- ... (Hidden Template for Image Generation Remains Same) ... -->
    <!-- 카드 공유 이미지 생성용 히든 템플릿 -->
    <div id="share-card-template">
        <div style="font-size: 14px; color: #888; margin-bottom: 20px; letter-spacing: 2px;" id="share-header">JANUARY PLAN</div>
        <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px;" id="share-date"></div>
        <div style="width: 40px; height: 1px; background: #ddd; margin: 15px auto;"></div>
        
        <div style="font-size: 22px; font-weight: bold; color: #111; line-height: 1.4; margin-bottom: 30px; word-break: keep-all;" id="share-question"></div>
        
        <div id="share-image-container" style="width: 100%; margin-bottom: 20px; display: none;">
            <img id="share-image" src="" style="width: 100%; max-height: 350px; object-fit: cover; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        </div>

        <div style="font-size: 16px; color: #444; line-height: 1.8; text-align: left; width: 100%; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 4px; white-space: pre-wrap; word-break: keep-all;" id="share-content"></div>

        <div style="margin-top: 40px; font-style: italic; color: #888; font-size: 12px;" id="share-quote"></div>
    </div>

    <script>
        // --- 1. Data Structure (January 31 Days) ---
        const journalData = [
            // ... (Same data) ...
            { chapter: "1. 새로운 그림 그리기", date: "1/1(수)", question: "올해 나를 이끌어줄 핵심 단어(Keyword)는 무엇인가요?", quote: "시작이 반이다. 그리고 나머지 반은 끝까지 해내는 것이다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/2(목)", question: "12월 31일의 내가 어떤 모습이기를 바라나요?", quote: "미래를 예측하는 가장 좋은 방법은 미래를 창조하는 것이다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/3(금)", question: "올해 절대 타협하고 싶지 않은 나만의 원칙은?", quote: "원칙이 있는 삶은 길을 잃지 않는다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/4(토)", question: "작년의 나보다 조금 더 성장하고 싶은 부분은?", quote: "어제보다 나은 오늘이 모여 위대한 내일이 된다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/5(일)", question: "올해 새롭게 도전해보고 싶은 '낯선 경험'은?", quote: "익숙함에서 벗어날 때 비로소 새로운 세상이 열린다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/6(월)", question: "나의 가슴을 가장 뛰게 하는 목표 하나는?", quote: "꿈을 꿀 수 있다면, 그 꿈을 이룰 수도 있다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/7(화)", question: "올해 내가 세상에 어떤 긍정적인 영향을 주고 싶나요?", quote: "가치 있는 삶은 타인의 삶을 더 아름답게 만드는 것이다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/8(수)", question: "나를 행복하게 만들기 위해 꼭 필요한 시간은?", quote: "자신을 사랑하는 것이 평생의 로맨스의 시작이다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/9(목)", question: "올해 꼭 가보고 싶은 장소는 어디인가요?", quote: "여행은 우리가 사는 장소를 바꿔주는 것이 아니라, 우리의 생각을 바꿔준다." },
            { chapter: "1. 새로운 그림 그리기", date: "1/10(금)", question: "올해의 내 인생 BGM(테마곡)을 정한다면?", quote: "인생은 리듬이다. 너만의 박자에 맞춰 춤을 춰라." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/11(토)", question: "건강한 신체를 위해 약속하고 싶은 한 가지는?", quote: "건강은 가장 큰 재산이다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/12(일)", question: "마음의 평온을 위해 챙겨야 할 습관은?", quote: "고요함 속에서 진정한 지혜가 자란다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/13(월)", question: "경제적인 목표나 자산 관리 계획이 있나요?", quote: "작은 구멍이 거대한 배를 침몰시킨다. 작은 지출을 아껴라." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/14(화)", question: "올해 읽고 싶은 책이나 배우고 싶은 분야는?", quote: "배움에는 끝이 없고, 성장에는 한계가 없다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/15(수)", question: "소중한 사람들과 어떻게 시간을 보내고 싶나요?", quote: "행복은 결국 사람과의 관계에서 온다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/16(목)", question: "업무나 커리어에서 이루고 싶은 성과는?", quote: "성공은 준비된 자에게 찾아온다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/17(금)", question: "나만의 공간(방/책상)을 어떻게 꾸미고 싶나요?", quote: "공간이 변하면 생각이 변하고, 생각이 변하면 인생이 변한다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/18(토)", question: "불필요한 낭비를 줄이기 위해 그만둘 것은?", quote: "무언가를 채우려면 먼저 비워야 한다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/19(일)", question: "매일 아침을 어떻게 시작하고 싶나요? (모닝 루틴)", quote: "아침을 지배하는 자가 하루를 지배한다." },
            { chapter: "2. 구체적인 지도 만들기", date: "1/20(월)", question: "하루를 마무리할 때 스스로에게 해주고 싶은 질문은?", quote: "오늘 하루, 나는 나에게 진실했는가?" },
            { chapter: "3. 첫 발걸음 떼기", date: "1/21(화)", question: "작심삼일을 극복하기 위한 나만의 치트키는?", quote: "포기하지 않는 한 실패는 없다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/22(수)", question: "목표를 이루기 위해 당장 이번 주에 해야 할 일은?", quote: "가장 위대한 계획도 실행하지 않으면 무용지물이다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/23(목)", question: "나를 응원해줄 '메이트'나 멘토가 있나요?", quote: "혼자 가면 빨리 가지만, 함께 가면 멀리 간다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/24(금)", question: "힘들 때 나를 다시 일으켜 세울 주문(Mantra)은?", quote: "이 또한 지나가리라. 그리고 나는 더 단단해지리라." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/25(토)", question: "1월 한 달 동안 가장 잘했다고 생각하는 작은 성공은?", quote: "작은 성공이 모여 큰 성공을 만든다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/26(일)", question: "계획대로 되지 않을 때, 어떻게 대처할 것인가요?", quote: "유연함이 강함을 이긴다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/27(월)", question: "바쁜 일상 속에서 '쉼표'를 어떻게 찍을까요?", quote: "휴식은 게으름이 아니라, 더 멀리 가기 위한 준비다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/28(화)", question: "1월을 보내며 수정하거나 보완해야 할 점은?", quote: "반성은 후회가 아니라 성장을 위한 거름이다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/29(수)", question: "남은 11개월을 위해 비축해야 할 에너지는?", quote: "열정은 속도가 아니라 지속력이다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/30(목)", question: "2월의 나에게 미리 보내는 응원의 메시지는?", quote: "너는 이미 충분히 잘하고 있다." },
            { chapter: "3. 첫 발걸음 떼기", date: "1/31(금)", question: "1월의 마지막 날, 스스로에게 해주고 싶은 칭찬은?", quote: "시작한 것만으로도 너는 이미 승리자다." }
        ];

        // --- 2. State Management ---
        let currentIndex = 0;
        const STORAGE_KEY = 'january_journal_entries'; 
        const STORAGE_KEY_IMAGES = 'january_journal_images'; 
        
        let userEntries = {}; 
        let userImages = {}; 

        // --- 3. DOM Elements & 4. Initialization ---
        // (DOM Elements)
        const chapterDisplay = document.getElementById('chapter-display');
        const dateDisplay = document.getElementById('date-display');
        const questionText = document.getElementById('question-text');
        const quoteText = document.getElementById('quote-text');
        const answerInput = document.getElementById('answer-input');
        const charCount = document.getElementById('char-count');
        const pageIndicator = document.getElementById('page-indicator');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const loadingOverlay = document.getElementById('loading');
        const tabContainer = document.getElementById('tab-container');
        const saveToast = document.getElementById('save-toast');
        const exportOverlay = document.getElementById('export-overlay');
        const btnExport = document.getElementById('btn-export');
        const imageGalleryContainer = document.getElementById('image-gallery-container');
        const imageList = document.getElementById('image-list');
        const imageInput = document.getElementById('image-upload');
        const shareOverlay = document.getElementById('share-overlay');
        const generatedShareImage = document.getElementById('generated-share-image');
        const shareCardTemplate = document.getElementById('share-card-template');
        const settingsOverlay = document.getElementById('settings-overlay');

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) userEntries = JSON.parse(savedData);
            
            const savedImages = localStorage.getItem(STORAGE_KEY_IMAGES);
            if (savedImages) {
                try {
                    const parsed = JSON.parse(savedImages);
                    for (const key in parsed) {
                        if (typeof parsed[key] === 'string') parsed[key] = [parsed[key]];
                    }
                    userImages = parsed;
                } catch (e) { console.error("Image load error", e); }
            }

            generateTabs();
            renderPage(currentIndex);
            setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 500);
        });

        // --- 5. Core Functions ---
        function generateTabs() {
            tabContainer.innerHTML = '';
            const row1 = document.createElement('div');
            row1.className = 'flex overflow-x-auto no-scrollbar gap-2 px-4 scroll-smooth';
            const row2 = document.createElement('div');
            row2.className = 'flex overflow-x-auto no-scrollbar gap-2 px-4 scroll-smooth';
            
            journalData.forEach((_, index) => {
                const btn = document.createElement('button');
                const dayNum = index + 1;
                btn.id = `tab-btn-${index}`;
                btn.className = `flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 border border-transparent hover:border-stone-300 focus:outline-none`;
                btn.textContent = `${dayNum}`;
                btn.onclick = () => { currentIndex = index; renderPage(index); };
                if (index < 16) row1.appendChild(btn); else row2.appendChild(btn);
            });
            tabContainer.appendChild(row1);
            tabContainer.appendChild(row2);
        }

        function updateTabs(index) {
            const allTabs = document.querySelectorAll('[id^="tab-btn-"]');
            allTabs.forEach(tab => tab.className = `flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 border border-transparent hover:bg-stone-200 text-stone-500`);
            const activeTab = document.getElementById(`tab-btn-${index}`);
            if (activeTab) {
                activeTab.className = `flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-200 bg-stone-700 text-white shadow-md transform scale-105`;
                activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function renderPage(index) {
            const data = journalData[index];
            chapterDisplay.textContent = data.chapter; 
            dateDisplay.textContent = data.date;
            questionText.textContent = data.question;
            quoteText.textContent = data.quote;
            pageIndicator.textContent = `${index + 1} / ${journalData.length}`;
            answerInput.value = userEntries[index] || "";
            updateCharCount();
            renderGallery(index);
            btnPrev.disabled = index === 0;
            btnNext.disabled = index === journalData.length - 1;
            updateTabs(index);
        }

        function renderGallery(index) {
            const images = userImages[index] || [];
            imageList.innerHTML = '';

            if (images.length > 0) {
                imageGalleryContainer.classList.remove('hidden');
                images.forEach((src, imgIdx) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'image-item group';
                    // Pass event to stop propagation
                    itemDiv.innerHTML = `
                        <img src="${src}" alt="기록 사진 ${imgIdx + 1}">
                        <button onclick="removeImage('${imgIdx}', event)" class="remove-image-btn" title="사진 삭제">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    `;
                    imageList.appendChild(itemDiv);
                });
                lucide.createIcons();
            } else {
                imageGalleryContainer.classList.add('hidden');
            }
        }

        function saveEntry() {
            userEntries[currentIndex] = answerInput.value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userEntries));
            updateCharCount();
        }

        function manualSave() {
            saveEntry();
            saveToast.classList.remove('hidden');
            saveToast.classList.add('toast-show');
            setTimeout(() => { saveToast.classList.remove('toast-show'); saveToast.classList.add('hidden'); }, 2000);
        }

        function updateCharCount() { charCount.textContent = answerInput.value.length; }
        function prevPage() { if (currentIndex > 0) { currentIndex--; renderPage(currentIndex); } }
        function nextPage() { if (currentIndex < journalData.length - 1) { currentIndex++; renderPage(currentIndex); } }
        answerInput.addEventListener('input', saveEntry);

        // --- 6. Image Handling Functions (Fixed) ---
        async function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            if (!userImages[currentIndex]) userImages[currentIndex] = [];

            let uploadCount = 0;
            const maxImagesPerDay = 10; 

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/')) continue;
                if (userImages[currentIndex].length >= maxImagesPerDay) { alert("하루에 최대 10장까지만 첨부할 수 있습니다."); break; }
                try {
                    const resizedDataUrl = await readFileAndResize(file);
                    userImages[currentIndex].push(resizedDataUrl);
                    uploadCount++;
                } catch (err) { console.error(err); }
            }

            if (uploadCount > 0) {
                try {
                    localStorage.setItem(STORAGE_KEY_IMAGES, JSON.stringify(userImages));
                    renderGallery(currentIndex);
                    imageInput.value = ''; 
                } catch (err) { alert("저장 용량 부족! 기존 사진을 정리해주세요."); }
            }
        }

        function readFileAndResize(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => { resizeImage(e.target.result, 600, (result) => resolve(result)); };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // IMPROVED REMOVE IMAGE FUNCTION
        function removeImage(imgIndexStr, event) {
            if (event) event.stopPropagation(); // Stop bubble to image click
            
            if (confirm("이 사진을 삭제하시겠습니까?")) {
                const idx = parseInt(imgIndexStr, 10);
                const images = userImages[currentIndex];
                
                if (images && images.length > idx) {
                    images.splice(idx, 1);
                    
                    if (images.length === 0) delete userImages[currentIndex];
                    
                    localStorage.setItem(STORAGE_KEY_IMAGES, JSON.stringify(userImages));
                    renderGallery(currentIndex);
                }
            }
        }

        function resizeImage(base64Str, maxWidth, callback) {
            const img = new Image();
            img.src = base64Str;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.6));
            };
        }

        // --- 7. Google Docs Export ---
        async function copyForGoogleDocs() {
            const originalBtnText = btnExport.innerHTML;
            btnExport.innerHTML = `<span class="animate-spin">⌛</span> 복사 준비 중...`;
            btnExport.disabled = true;

            const coverImage = "https://images.unsplash.com/photo-1517842645767-c639042777db?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";

            let htmlContent = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                    <div style="text-align: center; margin-bottom: 50px;">
                        <img src="${coverImage}" style="width: 100%; max-width: 600px; border-radius: 8px;">
                        <h1 style="font-size: 28pt; color: #333; margin-top: 20px;">1월의 기록</h1>
                        <p style="color: #666; font-size: 14pt;">설렘과 다짐의 기록</p>
                    </div>
                    <hr style="border: 0; border-top: 1px solid #ccc; margin-bottom: 40px;">
            `;

            journalData.forEach((data, index) => {
                const entry = userEntries[index] || "(작성된 내용이 없습니다)";
                const formattedEntry = entry.replace(/\n/g, '<br>');
                const images = userImages[index] || [];
                let imagesHtml = '';
                if (images.length > 0) {
                    imagesHtml = `<div style="text-align: center; margin-bottom: 15px;">`;
                    images.forEach(src => {
                        imagesHtml += `<img src="${src}" style="max-width: 100%; max-height: 400px; border-radius: 8px; margin-bottom: 10px; display: inline-block;"> <br>`;
                    });
                    imagesHtml += `</div>`;
                }
                htmlContent += `
                    <div style="margin-bottom: 40px;">
                        <div style="border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px;">
                            <strong style="font-size: 14pt; color: #2c3e50;">${data.date}</strong>
                            <span style="color: #95a5a6; font-size: 10pt; margin-left: 10px;">Day ${index + 1}</span>
                        </div>
                        <h3 style="font-size: 12pt; color: #000; margin-bottom: 15px;">Q. ${data.question}</h3>
                        ${imagesHtml}
                        <div style="background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 15px; color: #333;">${formattedEntry}</div>
                        <p style="text-align: center; font-style: italic; color: #7f8c8d; font-size: 10pt;">"${data.quote}"</p>
                    </div>
                `;
            });
            htmlContent += `</div>`;

            const manualArea = document.getElementById('manual-copy-area');
            manualArea.innerHTML = htmlContent;
            exportOverlay.style.display = 'flex';
            
            setTimeout(async () => {
                selectAllManual();
                let success = false;
                try { success = document.execCommand('copy'); } catch (e) { console.error("Copy failed", e); }

                const statusTitle = document.getElementById('status-title');
                const statusIcon = document.getElementById('status-icon');
                const statusMessage = document.getElementById('status-message');

                if (success) {
                    statusTitle.textContent = "복사 완료!";
                    statusTitle.className = "text-2xl font-bold book-font text-green-700 mb-2";
                    statusIcon.innerHTML = `<i data-lucide="check-circle-2" class="w-16 h-16 text-green-600"></i>`;
                    statusMessage.innerHTML = `클립보드에 복사되었습니다.<br>이제 구글 문서에서 <strong>Ctrl + V</strong> 를 누르세요.`;
                } else {
                    statusTitle.textContent = "수동 복사 필요";
                    statusTitle.className = "text-2xl font-bold book-font text-amber-600 mb-2";
                    statusIcon.innerHTML = `<i data-lucide="clipboard-copy" class="w-16 h-16 text-amber-500"></i>`;
                    statusMessage.innerHTML = `자동 복사가 차단되었습니다.<br>아래 파란색으로 선택된 영역이 보이시죠?<br><strong>Ctrl + C</strong> 를 직접 눌러주세요.`;
                }
                lucide.createIcons();
                btnExport.innerHTML = originalBtnText;
                btnExport.disabled = false;
            }, 300);
        }

        function selectAllManual() {
            const manualArea = document.getElementById('manual-copy-area');
            const range = document.createRange();
            range.selectNodeContents(manualArea);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        function copyToClipboardManual() {
            selectAllManual();
            document.execCommand('copy');
            alert("복사를 다시 시도했습니다. 이제 붙여넣기 해보세요!");
        }

        // --- 8. Share Feature ---
        async function shareCurrentCard() {
            const data = journalData[currentIndex];
            const entry = userEntries[currentIndex] || "";
            const images = userImages[currentIndex] || [];

            document.getElementById('share-header').textContent = data.chapter.toUpperCase();
            document.getElementById('share-date').textContent = data.date;
            document.getElementById('share-question').textContent = data.question;
            document.getElementById('share-content').textContent = entry.substring(0, 300) || "(내용 없음)";
            document.getElementById('share-quote').textContent = data.quote;

            const shareImgContainer = document.getElementById('share-image-container');
            const shareImg = document.getElementById('share-image');
            
            if (images.length > 0) {
                shareImg.src = images[0];
                shareImgContainer.style.display = 'block';
            } else {
                shareImgContainer.style.display = 'none';
                shareImg.src = "";
            }

            try {
                const canvas = await html2canvas(shareCardTemplate, { scale: 2, useCORS: true, backgroundColor: '#fffefb' });
                generatedShareImage.src = canvas.toDataURL('image/png');
                if (navigator.share) {
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], 'reflection_card.png', { type: 'image/png' });
                        try { await navigator.share({ title: '1월의 기록', text: '새해의 설렘과 다짐', files: [file] }); } 
                        catch (err) { shareOverlay.style.display = 'flex'; }
                    });
                } else {
                    shareOverlay.style.display = 'flex';
                }
            } catch (err) { alert("이미지 생성 중 오류가 발생했습니다."); }
        }

        function downloadShareImage() {
            const link = document.createElement('a');
            link.download = `기록_${journalData[currentIndex].date}.png`;
            link.href = generatedShareImage.src;
            link.click();
        }

        // --- 9. Backup & Restore ---
        function openSettings() { settingsOverlay.style.display = 'flex'; }
        function backupData() {
            const backupData = { entries: userEntries, images: userImages, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `january_journal_backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            closeOverlay('settings-overlay');
        }
        function restoreData(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (parsed.entries) { userEntries = parsed.entries; localStorage.setItem(STORAGE_KEY, JSON.stringify(userEntries)); }
                    if (parsed.images) { userImages = parsed.images; localStorage.setItem(STORAGE_KEY_IMAGES, JSON.stringify(userImages)); }
                    alert('데이터가 성공적으로 복구되었습니다!');
                    renderPage(currentIndex);
                    closeOverlay('settings-overlay');
                } catch (err) { alert('파일 형식이 올바르지 않습니다.'); }
            };
            reader.readAsText(event.target.files[0]);
            event.target.value = '';
        }
        function resetData() {
            if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_KEY_IMAGES);
                userEntries = {}; userImages = {};
                renderPage(currentIndex);
                closeOverlay('settings-overlay');
                alert('초기화되었습니다.');
            }
        }
        function openGoogleDocs() { window.open('https://doc.new', '_blank'); closeOverlay('export-overlay'); }
        function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>